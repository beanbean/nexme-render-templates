CREATE OR REPLACE FUNCTION get_personal_progress_card(p_user_id UUID)
RETURNS JSONB
LANGUAGE plpgsql
AS $$
DECLARE
    v_round_id UUID;
    v_start_date DATE;
    v_initial_weight NUMERIC;
    v_current_weight NUMERIC;
    v_player_name TEXT;
    v_avatar_url TEXT;
    v_team_name TEXT;
    v_days_json JSONB;
    v_result JSONB;
    v_total_loss NUMERIC;
BEGIN
    -- 1. Lấy thông tin
    SELECT r.id, r.start_date, ui.display_name, ui.avatar_url, t.name
    INTO v_round_id, v_start_date, v_player_name, v_avatar_url, v_team_name
    FROM rounds r
    JOIN unified_identity ui ON ui.id = p_user_id
    LEFT JOIN team_members tm ON tm.player_id = ui.id
    LEFT JOIN teams t ON t.id = tm.team_id
    WHERE r.start_date <= CURRENT_DATE AND r.end_date >= CURRENT_DATE
    LIMIT 1;

    IF v_round_id IS NULL THEN RETURN NULL; END IF;

    -- 2. Lấy cân nặng
    SELECT initial_weight INTO v_initial_weight FROM enrollments WHERE player_id = p_user_id AND round_id = v_round_id;
    SELECT weight INTO v_current_weight FROM daily_logs WHERE player_id = p_user_id AND round_id = v_round_id AND log_date = CURRENT_DATE;
    v_total_loss := COALESCE(v_current_weight, v_initial_weight) - v_initial_weight;

    -- 3. Tạo dữ liệu lưới 10 ngày (Logic Status chuẩn)
    SELECT jsonb_agg(d) INTO v_days_json
    FROM (
        SELECT 
            i as day_index,
            'DAY ' || i as label,
            CASE 
                WHEN dl.weight IS NOT NULL AND prev_dl.weight IS NOT NULL 
                THEN CAST((dl.weight - prev_dl.weight) * 1000 AS INT)
                ELSE NULL 
            END as value_g,
            
            -- Logic Status
            CASE 
                WHEN (v_start_date + (i - 1) * INTERVAL '1 day') > CURRENT_DATE THEN 'future' -- Ngày tương lai
                WHEN dl.weight IS NULL THEN 'missing' -- Ngày quá khứ mà chưa nhập
                WHEN (dl.weight - prev_dl.weight) > 0 THEN 'gain'
                WHEN (dl.weight - prev_dl.weight) < 0 THEN 'loss'
                ELSE 'flat'
            END as status,
            
            -- Leader Logic (Tạm thời false, nâng cấp sau)
            false as leader

        FROM generate_series(1, 10) i
        LEFT JOIN daily_logs dl ON dl.player_id = p_user_id AND dl.round_id = v_round_id 
            AND dl.log_date = (v_start_date + (i - 1) * INTERVAL '1 day')
        LEFT JOIN daily_logs prev_dl ON prev_dl.player_id = p_user_id AND prev_dl.round_id = v_round_id 
            AND prev_dl.log_date = (v_start_date + (i - 2) * INTERVAL '1 day')
        ORDER BY i ASC
    ) d;

    -- 4. Đóng gói JSON
    v_result := jsonb_build_object(
        'template', 'personal-progress/template',
        'player', jsonb_build_object(
            'name', v_player_name,
            'team', COALESCE(v_team_name, 'Freelancer'),
            'avatar', v_avatar_url,
            'date', to_char(CURRENT_DATE, 'Month DD, YYYY')
        ),
        'stats', jsonb_build_object(
            'start', v_initial_weight,
            'finish', COALESCE(v_current_weight, v_initial_weight),
            'result', v_total_loss,
            'lap_number', 1 -- Hardcode Lap 1 cho MVP
        ),
        'days', v_days_json
    );

    RETURN v_result;
END;
$$;
